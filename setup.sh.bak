#!/bin/bash

# Colors
YELLOW="\033[1;33m"
RESET="\033[0m"

protocols=(
    bluez
    bluez-utils
    brightnessctl
    pipewire
    pipewire-pulse
    ttf-jetbrains-mono-nerd
    wireplumber
)

cli_tools=(
    kitty
    git
    neovim
    tmux
    fastfetch
    bluetui
    ncpamixer
		stow
		sdkman
		unzip
		starship
		less
		man-db
		man-pages
)

gui_applications=(
    hyprland
		hyprlock
    waybar
    dunst
    rofi
    google-chrome
		timeshift
		feishin-bin
		postman
		vscode
		intellij-idea-community-edition
)

other_tools=(
	docker
	docker-compose
	grub-btrfs
	innotify-tools
	timeshift-autosnap
	autofs
)

install_packages() {
    local group_name="$1"
    shift
    echo -e "\n\n${YELLOW}=== Installing $group_name ===${RESET}\n"
    yay -S --noconfirm "$@"
}

install_packages "protocols"        "${protocols[@]}"
install_packages "cli tools"        "${cli_tools[@]}"
install_packages "gui applications" "${gui_applications[@]}"
install_packages "other tools" "${other_tools[@]}"

install_packages "tools without package-manager" "${()}"
bash -c "$(curl -fsSL https://raw.githubusercontent.com/ohmybash/oh-my-bash/master/tools/install.sh)"
git clone https://github.com/tmux-plugins/tpm ~/.config/tmux/plugins/tpm
export sdkman_auto_answer=true
curl -s "https://get.sdkman.io" | bash


echo -e "\n\n${YELLOW}=== Configure grub-btrfsd & timeshift-autosnap ===${RESET}\n"
sudo /etc/grub.d/41_snapshots-btrfs

UNIT_PATH=$(systemctl show -p FragmentPath grub-btrfsd | cut -d= -f2) # returns the path of service-file

sudo sed -i 's|^ExecStart=.*|ExecStart=/usr/bin/grub-btrfsd --syslog --timeshift-auto|' "$UNIT_PATH"
sudo systemctl daemon-reload
sudo systemctl enable --now grub-btrfsd


echo -e "\n\n${YELLOW}=== Install tmux-tpm plugins ===${RESET}\n"
tmux start-server
tmux new-session -d
~/.tmux/plugins/tpm/scripts/install_plugins.sh
tmux kill-server

echo -e "\n\n${YELLOW}=== Configure Docker ===${RESET}\n"
sudo groupadd docker
sudo usermod -aG docker $USER

echo -e "\n\n${YELLOW}=== Configure autofs ===${RESET}\n"
line="/cifs /etc/autofs/auto.smb --timeout=300"
file="/etc/autofs/auto.master"
if ! grep -qxF "$line" "$file"; then
	echo "$line" | sudo tee -a "$file" > /dev/null
fi

sudo systemctl restart autofs
sudo systemctl enable --now autofs

line="file:///cifs/192.168.178.101 TrueNAS"
file="~/.config/gtk-3.0/bookmarks"
if ! grep -qxF "$line" "$file"; then
	echo "$line" | sudo tee -a "$file" > /dev/null
fi
